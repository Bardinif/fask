{% extends "base.html" %}

{% block subtitle %}Dashboard{% endblock %}

{% block content %}

{% load staticfiles %}
<div class="row" style="margin-bottom: 25px">
	<div class="col-lg-8">
		<button id = "show_complete_button" type="button" class="block col-lg-3" onclick="Show_Complete()"><img id="show_complete" src="{% static 'img/buttons/Gnome-colors-emblem-desktop-alt-aply-64.png' %}" alt="Completed"/><br/>Visulazza Completati</button>
		<button id = "show_supervisor_button" type="button" class="block col-lg-3" onclick="Show_Supervisor()"><img id="show_supervisor" src="{% static 'img/buttons/Gnome-user-64.png' %}" alt="Assigned Projencts"/><br/> Visualizza Solo Progetti Utente</button>
		<button id = "show_task_button" type="button" class="block col-lg-3" onclick="Show_Task()"><img id="show_task" src="{% static 'img/buttons/Gnome-system-mytask-64.png' %}" alt="Assigned Task"/><br/> Visualizza Solo Task Utente</button>
		<button  type="button" class="block col-lg-3" onclick="location.href='{% url "project" 0  %}';"><img id="show_task" src="{% static 'img/buttons/Gnome-document-new-64.png' %}" alt="New Projects"/><br/> Nuovo Progetto</button>
	</div>
{% if projects %}
	<div class="col-lg-4">
			<input type="text" class = "form-control" id = "myInput" onkeyup="myFunction()" placeholder="Ricerca per Progetto o Supervisore..." style="width: 300px; margin: 20px; margin-left: 5px; float: right;">
			<i class="fa fa-search fa-1x" style="width: 10px; margin: 20px; margin-top: 30px; margin-right: 5px; float: right;"></i>
	</div>
</div>
 <div class="row">
    {% for obj in projects %}
	    <div class="row">
	        <div class="col-lg-12">
	            <div class="panel panel-primary" id="projects_{{obj.description}}">
	                <div class="panel-heading">
	                    <div class="row">
	                        <div class="col-xs-1">
	                            <button type="button" class="btn btn-default btn-xs-2" onclick="location.href='{% url "project" obj.id %}';">
	                            	<i class="fa fa-pencil fa-1x"></i>
	                            </button>
	                        </div> <!-- div class="col-xs-3" -->
	                        <span class="pull-right">
                                 <button type="button" class="btn btn-outline btn-primary btn-xs-2" onClick="location.href='{% url 'project_delete' obj.id %}'" style = "background-color: white; margin: 20px;"><i class="fa fa-trash-o"></i></button>
                            </span>
	                        <div class="col-xs-9">
	                            <h3>{{ obj.description }}</h3>
	                            <div>
	                                {% if obj.supervisor %}
                                        <button type="button" class="btn btn-default btn-xs" id="supervisor_{{ obj.supervisor }}_{{obj.description}}" value="projects_{{obj.description}}">Supervisor: {{ obj.supervisor }}</button>
                                    {% else %}
                                    	<button type="button" class="btn btn-default btn-xs" id="supervisor_nessun_supervisor_{{obj.description}}" value="projects_{{obj.description}}">Supervisor: -nessuno- </button>
                                    {% endif %}
                                </div>
	                            <div>{{ obj.annotation }}</div>

	                        </div> <!-- div class="col-xs-9 text-right" -->
	                        
	                    </div> <!-- div class="row" -->
	                    
	                </div> <!-- div class="panel-heading" -->
	                
                   <div class="panel-body">
                        {% for sub in obj.task_project_owner.all %}
                        	{% if request.GET.filter_assegnee == "False" or sub.assigned_to.username == request.user.username or not request.GET.filter_assegnee %}
		                           {% if sub.progression|truncatewords:"2" == "99 - ..." %}
		                            	<div class="panel" id="sub_{{sub.description}}" value = "projects_{{obj.description}}" style=" background-color : #65d046; display: none">
		                           {% else %}
		                            	<div class="panel panel-info" id="sub_{{sub.description}}" value ="projects_{{obj.description}}">
		                           {% endif %}
		                                <div class="panel-heading clearfix">
					                        <span class="pull-left">
												<button type="button" class="btn btn-default btn-xs"  onclick="location.href='{% url "task_project" sub.id obj.id 'dashboard' %}';"><i class="fa fa-pencil fa-1x"></i></button>
												  
					                        	<button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="bottom" title="{{ sub.annotation }}" value="{{sub.progression}}" id="coplete_sub_{{sub.description}}">
					                        		{{ sub.description }}
					                        		{% if sub.progression.id == 3 %}
					                        			</del>
					                        		{% endif %}
					                        	</button>
					                        </span>
					                        <span class="pull-right">
					                        	{% if sub.due_to %}
					                        		<button type="button" class="btn btn-default btn-xs">Due To: {{ sub.due_to }}</button>
					                        	{% endif %}
					                        	{% if sub.assigned_to %}
					                        		<button type="button" class="btn btn-default btn-xs" id="assigned_{{ sub.assigned_to }}_{{obj.description}}" value="sub_{{sub.description}}">Assigned To: {{ sub.assigned_to }}</button>
					                        	{% else %}
					                        		<button type="button" class="btn btn-default btn-xs" id="assigned_{{ sub.assigned_to }}_{{obj.description}}" value="sub_{{sub.description}}">Assigned To: -nessuno-</button>
					                        	{% endif %}
					                        	{% if sub.priority.id == 1 %}
						                        	<button type="button" class="btn btn-success btn-xs">{{sub.priority}}</button>
						                        {% elif sub.priority.id == 2 %}
						                        	<button type="button" class="btn btn-warning btn-xs">{{sub.priority}}</button>
						                        {% elif sub.priority.id == 3 %}
						                        	<button type="button" class="btn btn-danger btn-xs">{{sub.priority}}</button>
						                        {% endif %}
						                          
					                        	{% if sub.progression %}
						                        	<button type="button" class="btn btn-primary btn-xs">{{sub.progression}}</button>
						                        	{% if sub.progression.id == 3 and sub.completed_on %}
						                        		<button type="button" class="btn btn-default btn-xs">Completed On: {{ sub.completed_on }}</button>
						                        	{% endif %}
						                        {% endif %}
						                        <button type="button" class="btn btn-default btn-xs" onclick="location.href='{% url "subtask_task" 0 sub.id 'dashboard' %}';"><i class="fa fa-plus-circle fa-1x"></i></button>
						                        <button type="button" class="btn btn-outline btn-primary btn-xs" onClick="location.href='{% url 'task_delete' sub.id %}'" style = "background-color: white;"><i class="fa fa-trash-o"></i></button>
			                                                    
					                        </span>
		
		                                </div> <!-- div class="panel-heading clearfix" -->
		                                
		                                {% if sub.task_owner.all %}
		                                <div class="panel-body">
		
		                                    {% for sub2 in sub.task_owner.all %}
			                                    {% if sub2.completed %}
			                                    	<div class="panel panel-" id="sub2_{{sub.description}}_{{sub2.description}}" value = "completed" style=" background-color :  #8db681; display: none">
			                                    {% else %}
			                                        <div class="panel panel-info" id="sub2_{{sub.description}}_{{sub2.description}}" value = "workin_progres" >
			                                    {% endif %}
			                                            <div class="panel-heading clearfix">
			                                                <span class="pull-left">
			                                                <button type="button" class="btn btn-default btn-xs" onclick="location.href='{% url "subtask_task" sub2.id sub.id 'dashboard' %}';"><i class="fa fa-pencil fa-1x"></i></button>

			                                                	<button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="bottom" title="{{ sub2.annotation }}">{{ sub2.description }}</button>

																<button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="bottom" title="{{ sub2.annotation }}">{{ sub2.description }}</button>
			                                                

			                                                </span>
			                                                <span class="pull-right">
			                                                	{% if sub2.completed and sub2.completed_on %}
			                                                        <button type="button" class="btn btn-default btn-xs">Completed On: {{ sub2.completed_on }}</button>
			                                                    {% endif %}
			                                                    <button type="button" class="btn btn-outline btn-primary btn-xs" onClick="location.href='{% url 'subtask_delete' sub2.id %}'" style = "background-color: white;"><i class="fa fa-trash-o"></i></button>
			                                                    
			                                                </span>
			                                                <!-- <div class="clearfix"></div> -->
			                                            </div> <!-- div class="panel-heading clearfix" -->

			                                        </div> <!-- div class="panel panel-info" -->
		                                    {% endfor %}
		
		                                </div>  <!-- div class="panel-body" -->
		                                {% endif %}
		                                    
		                            </div> <!-- div class="panel panel-default" -->
		                            
	                    {% endif %}
	

                        {% endfor %}
                            
                    </div> <!-- div class="panel-body pull-right" -->

                    <a href="{% url 'task_project' 0 obj.id 'dashboard' %}">
                        <div class="panel-footer">
                            <span class="pull-left">Add Task</span>
                            <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                            <div class="clearfix"></div>
                        </div>
                    </a>

                    
	            </div> <!-- div class="panel panel-primary" -->

			                                            
    {% endfor %}
	
</div>
{% else %}
    <p>Nessuna progetto presente.</p>
    <p>Se sono stati attivati dei filtri controllare di avere eseguito il login<p>
</div>
{% endif %}

<script language="JavaScript" type="text/javascript" src="/js/jquery-1.2.6.min.js"></script>
<script language="JavaScript" type="text/javascript" src="/js/jquery-ui-personalized-1.5.2.packed.js"></script>
<script language="JavaScript" type="text/javascript" src="/js/sprinkle.js"></script>
<script src="{% static 'css/vendor/jquery/jquery.min.js'%}"></script>
<script type="text/javascript">

var show_complete 	= false;
var show_supervisor = false;
var show_task		= false;
var actual_user		= "{{user}}";
var PrgSet			= new Set();
var Task1Set		= new Set();
var Task2Set		= new Set();
var SubSet			= new Set();

$(document).ready(function() {

	var supervisor_button_list	= $('[id^="supervisor_"]');
	var projects_list 			= $('[id^="projects_"]');
  	var panel_list 				= $('[id^="sub_"]');
  	var sub_panel_list 			= $('div[id^="sub2_"]');
	
	for (i = 0; i < projects_list.length; i++) {
		PrgSet.add(projects_list[i].id);
	}
	for (i = 0; i < panel_list.length; i++) {
		Task1Set.add(panel_list[i].id);
		complete_button = document.getElementById("coplete_" + panel_list[i].id);
		if(complete_button.value[0] != 9 && complete_button.value[1] != 9) Task2Set.add(panel_list[i].id);
	}
	for (i = 0; i < sub_panel_list.length; i++) {
		if(sub_panel_list[i].getAttribute('value') != "completed") SubSet.add(sub_panel_list[i].id);
	}
});
	

function myFunction() {
  // Declare variables
  var input, filter, panel, tr, td, i, txtValue;
  input = document.getElementById("myInput");
  filter = "projects_" + input.value;
  filter = filter.toUpperCase();
  panel_list = $('div[id^="projects_"]');
  super_visor_list = $('[id^="supervisor_"]')

  // Loop through all table rows, and hide those who don't match the search query
  for (i = 0; i < panel_list.length; i++) {

    if (panel_list[i]) {
      txtValue = panel_list[i].id
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        panel_list[i].style.display = "";
      } else {
        panel_list[i].style.display = "none";
      }
    }
  }
  filter = "supervisor_" + input.value;
  filter = filter.toUpperCase()
  for (i = 0; i < super_visor_list.length; i++) {
    if (super_visor_list[i].value) {
      txtValue = super_visor_list[i].id;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        panel = document.getElementById(super_visor_list[i].value);
        panel.style.display = "";
      }
    }
  }
}

function Show_Complete() {
	show_complete = !show_complete;
	Control_Complete();
	Show_Function();
  	if(show_complete){
		document.getElementById("show_complete").src = "{% static "img/buttons/Gnome-colors-emblem-desktop-alt-64.png" %}" ;
		document.getElementById("show_complete_button").lastChild.data = "Nascondi Completati";
	}
	else{
		document.getElementById("show_complete").src = "{% static "img/buttons/Gnome-colors-emblem-desktop-alt-aply-64.png" %}" ;
		document.getElementById("show_complete_button").lastChild.data = "Visualizza Completati";
	}
}

function Show_Supervisor() {
  	show_supervisor = !show_supervisor;
	Control_User();
	Show_Function();
  	if(show_supervisor){
		document.getElementById("show_supervisor").src = "{% static "img/buttons/Gnome-users-64.png" %}" ;
		document.getElementById("show_supervisor_button").lastChild.data = "Visualizza Tutti i Progetti";
	}
	else{
		document.getElementById("show_supervisor").src = "{% static "img/buttons/Gnome-user-64.png" %}" ;
		document.getElementById("show_supervisor_button").lastChild.data = "Visualizza Solo Progetti Utente";
	}
}

function Show_Task() {
  	show_task = !show_task;
	Control_User();
	Show_Function();
  	if(show_task){
		document.getElementById("show_task").src = "{% static "img/buttons/Gnome-system-alltask-64.png" %}" ;
		document.getElementById("show_task_button").lastChild.data = "Visualizza Tutti i Task";
	}
	else{
		document.getElementById("show_task").src = "{% static "img/buttons/Gnome-system-mytask-64.png" %}" ;
		document.getElementById("show_task_button").lastChild.data = "Visualizza Solo Task Utente";
	}
}

function Control_User(){
	PrgSet			= new Set();
	Task1Set		= new Set();
	var supervisor_button_list	= $('[id^="supervisor_"]');
	var assigned_button_list 	= $('[id^="assigned_"]');
	var projects_list 			= $('[id^="projects_"]');
	var sub_panel_list 			= $('[id^="sub_"]');
	var PrgSet2 = new Set();
	
    if (show_supervisor) {
    	for (i = 0; i < supervisor_button_list.length; i++) { 
    		if(supervisor_button_list[i].id.includes("_" + actual_user) && actual_user != ""){ 	
	    		if(!PrgSet.has(supervisor_button_list[i].getAttribute('value'))) PrgSet.add(supervisor_button_list[i].getAttribute('value'));	
	    	}
	    }
	}
	else{
		for (i = 0; i < projects_list.length; i++) { 
			 PrgSet.add(projects_list[i].id);	
		}
	}
	if (show_task) {
    	for (i = 0; i < assigned_button_list.length; i++) { 
    		if(assigned_button_list[i].id.includes("_" + actual_user) && actual_user != ""){ 
    			task_element = document.getElementById(assigned_button_list[i].getAttribute('value'));
		    	if(PrgSet.has(task_element.getAttribute('value'))){ 
		    		Task1Set.add(task_element.id);
		    		if(!PrgSet2.has(task_element.getAttribute('value'))) PrgSet2.add(task_element.getAttribute('value'));	
		    	}
	    	}
	    }
	    PrgSet = PrgSet2;
	 }
	 else{
	    for (i = 0; i < sub_panel_list.length; i++) { 
    		if(PrgSet.has(sub_panel_list[i].getAttribute('value'))) Task1Set.add(sub_panel_list[i].id);		
	   	}
	}
}

function Control_Complete(){
	var coplete_button_list  	= $('[id^="coplete_sub_"]');
  	var panel_list 				= $('[id^="sub_"]');
  	var sub_panel_list 			= $('div[id^="sub2_"]');
	Task2Set 	= new Set();
	SubSet		= new Set();
	for(i = 0; i < panel_list.length; i++){
		if(show_complete){
	 		if(!Task2Set.has(panel_list[i].id)) Task2Set.add(panel_list[i].id);

		}
		else{
		 	complete_button = document.getElementById("coplete_" + panel_list[i].id);
		 	if(complete_button.value[0] != 9 && complete_button.value[1] != 9){
		 		if(!Task2Set.has(panel_list[i].id)) Task2Set.add(panel_list[i].id);
		 	}
		 }
	}
	for(i = 0; i < sub_panel_list.length; i++){
		if(show_complete){
	 		if(!SubSet.has(sub_panel_list[i].id)) SubSet.add(sub_panel_list[i].id);
	 	}
		else{
			
		 	if(sub_panel_list[i].getAttribute('value') != "completed"){
		 		if(!SubSet.has(sub_panel_list[i].id)) SubSet.add(sub_panel_list[i].id);
		 	}
		 }
	}
	
		
}	

function Show_Function(){
	var coplete_button_list = $('[id^="coplete_sub_"]');

  	var projects_list 		= $('[id^="projects_"]');
  	var panel_list 			= $('div[id^="sub_"]');
  	var sub_panel_list		= $('div[id^="sub2_"]');
	
   	for (i = 0; i < projects_list.length; i++) { 
   		if(PrgSet.has(projects_list[i].id)) projects_list[i].style.display = "";
   		else projects_list[i].style.display = "none";
   	}
   	for (i = 0; i < panel_list.length; i++) { 
   		if(Task1Set.has(panel_list[i].id) && Task2Set.has(panel_list[i].id)) panel_list[i].style.display = "";
   		else panel_list[i].style.display = "none";
   	}
   	for (i = 0; i < sub_panel_list.length; i++) { 
   		if(SubSet.has(sub_panel_list[i].id)) sub_panel_list[i].style.display = "";
   		else sub_panel_list[i].style.display = "none";
   	}
}

</script>   
{% endblock %}